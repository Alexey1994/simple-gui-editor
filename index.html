<!DOCTYPE html>
<html>
<head>
    <title></title>

    <style>
        html, body
        {
            position:         relative;
            padding:          0;
            margin:           0;
            height:           100%;
            font-family:      Arial;
            background-color: #aaa;
        }

        #content, .ace_editor
        {
            height: 100%;
        }
    </style>
</head>
<body>
    <!--script src="component compilation.js"></script-->

    <div id="view"></div>
    <div id="content">
        <button onclick="stringifyComponent()">Stringify</button>
        <button onclick="updateEditor()">Update all</button>
    </div>

    <div id="testPreview"></div>

    <script src="ace/ace.js"></script>
    <script src="ace/mode-javascript.js"></script>
    <script src="ace/snippets/javascript.js"></script>

    <script src="text width.js"></script>
    <script src="component.js"></script>
    <script src="components.js"></script>
    <script src="elements list.js"></script>
    <script src="component preview.js"></script>
    <script src="element editor.js"></script>
    <script src="component structure.js"></script>
    <script src="code editor.js"></script>
    <script src="inputs and outputs editor.js"></script>

    <script>
        var elementEditor
        var structureEditor
        var inputsAndOutputsEditor

        var createScript = '// Create script'
        var initScript = '// Init script'
        var changeScript = '// Change script'
        var destroyScript = '// Destroy script'

        var Page = AnonimComponent({
            name: 'Page',
            
            structure: [
                ['mainLayout', Grid, [
                    ['topLayout', Grid, [
                        [ElementsList],
                        ['componentPreviewWrapper', Rectangle, [
                            [ComponentPreview]
                        ]],
                        ['tabs', TabPanel]
                    ]],

                    ['bottomLayout', Grid, [
                        ['scriptTabPanel', TabPanel],
                        ['inputsAndOutputsEditor', InputsAndOutputsEditor]
                    ]]
                ]]
            ],

            init: function() {
                this.mainLayout.rows = 'calc(100% - 200px) 200px'
                this.mainLayout.gap = '20px'

                this.topLayout.columns = 'min-content auto min-content'
                this.topLayout.rows = '100%'
                this.topLayout.gap = '20px'
                this.topLayout.height = '100%'

                this.componentPreviewWrapper.color = '#fff'

                this.tabs.tabNames = ['Element', 'Structure']
                this.tabs.pages = [ElementEditor, ComponentStructure]

                this.tabs.tabChanged = {
                    'Element': tab => {
                        elementEditor = tab
                        structureEditor = undefined
                        //elementEditor.element = selectedElement
                    },

                    'Structure': tab => {
                        elementEditor = undefined
                        structureEditor = tab
                        structureEditor.structure = structure
                    }
                }

                this.bottomLayout.columns = 'auto min-content'
                this.bottomLayout.gap = '20px'

                this.scriptTabPanel.tabNames = ['Create', 'Init', 'Change', 'Destroy']
                this.scriptTabPanel.pages = [CodeEditor, CodeEditor, CodeEditor, CodeEditor]

                this.scriptTabPanel.tabChanged = {
                    'Create': tab => {
                        tab.value = createScript
                        tab.valueChange = newScript => createScript = newScript
                    },

                    'Init': tab => {
                        tab.value = initScript
                        tab.valueChange = newScript => initScript = newScript
                    },

                    'Change': tab => {
                        tab.value = changeScript
                        tab.valueChange = newScript => changeScript = newScript
                    },

                    'Destroy': tab => {
                        tab.value = destroyScript
                        tab.valueChange = newScript => destroyScript = newScript
                    }
                }

                /*tab => {
                    switch(tab.name) {
                        case 'Create':
                            tab.tab.value = 'Hi'
                            break
                    }
                    console.log(tab)
                }*/

                inputsAndOutputsEditor = this.inputsAndOutputsEditor
            }
        })

        var page = Page(document.querySelector('#content'))

        function updateEditor() {
            if(page)
                destroyComponentView(page)

            page = Page(document.querySelector('#content'))
        }
    </script>

    <script>
        function defineComponent(component) {
            function getStructureDefinition(structure) {
                var data = '['

                structure.forEach((node, index) => {
                    data += '['

                    if(node[0] !== undefined)
                        data += `"${node[0]}",`

                    data += `${node[1]}`

                    if(node[2].length)
                        data += ',' + getStructureDefinition(node[2])

                    data += ']'

                    if(index !== structure.length - 1)
                        data += ','
                })

                console.log(structure)
                return data + ']'
            }

            var data = `var ${component.name} = Component({`
            data += `name: "${component.name}",`
            data += `structure: ${getStructureDefinition(component.structure)},`
            data += `inputs: ${JSON.stringify(component.inputs)},`
            data += `outputs: ${JSON.stringify(component.outputs)},`
            data += `create: function(){${component.create}\n},`
            data += `init: function(){${component.init}\n},`
            //data += `change: function(){${component.change}\n},`
            data += `destroy: function(){${component.destroy}\n}`
            data += '})'

            data += `;${component.name}(testPreview)`

            console.log(data)

            window.eval(data)
        }

        function stringifyComponent() {
            var inputs = inputsAndOutputsEditor.self.inputs
            var outputs = inputsAndOutputsEditor.self.outputs

            function stringifyStructureNode(node) {
                var wrappedComponent = node.element.self.wrappedComponent
                var innerStructure = node.innerStructureDescription.map(stringifyStructureNode)

                //if(node.name !== undefined)
                    return [node.name, wrappedComponent.name, innerStructure, node.inputs]
                //else
                //    return [wrappedComponent.name, innerStructure, node.inputs]
            }

            var newStructure = structure.map(node => {
                return stringifyStructureNode(node)
            })

            var component = {
                name: `C_${Date.now()}`,
                structure: newStructure,

                inputs,
                outputs,

                create: createScript,
                init: initScript,
                change: changeScript,
                destroy: destroyScript
            }

            console.log(component)
            defineComponent(component)
        }
    </script>

    <!--script src="text width.js"></script>
    <script src="component.js"></script>
    <script src="components.js"></script>

    <script>
        var T = Component({
            name: 'TestComponent',

            structure: [
                ['1', Rectangle2, [
                    ['2', Rectangle2, 'inner-content']
                ]]
            ],

            init: function() {

            }
        })

        var t = T(document.body, [[Button]])
    </script-->
</body>
</html>